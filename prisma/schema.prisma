generator client {
  provider   = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


// -------------------- ENUMS --------------------
enum BoardType {
  SCRUM
  KANBAN
}

enum SprintStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum TicketAction {
  CREATED
  UPDATED
  DELETED
  STATUS_CHANGED
  ASSIGNEE_CHANGED
}

// -------------------- AUTH & RBAC --------------------
model User {
  id             Int              @id @default(autoincrement()) @map("id")
  roleId        Int              @map("role_id")
  email          String           @unique @map("email")
  passwordHash  String           @map("password_hash")
  fullName      String           @map("full_name")
  isActive      Boolean          @default(true) @map("is_active")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  role           Role             @relation(fields: [roleId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  projectsCreated Project[]      @relation("ProjectsCreated")
  projects       ProjectUser[]
  reportedTickets Ticket[]       @relation("ReportedTickets")
  assignedTickets Ticket[]       @relation("AssignedTickets")
  ticketComments TicketComment[]
  ticketHistories TicketHistory[] @relation("UpdatedHistories")
  uploadedAttachments    Attachment[]

  @@map("users")
}

model Role {
  id              Int               @id @default(autoincrement()) @map("id")
  name            String            @unique @map("name")
  users           User[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Resource {
  id               Int               @id @default(autoincrement()) @map("id")
  name             String?           @map("name")
  rolePermissions RolePermission[]

  @@map("resources")
}

model RolePermission {
  roleId     Int  @map("role_id")
  resourceId Int  @map("resource_id")

  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([roleId, resourceId])
  @@map("role_permissions")
}

// -------------------- PROJECT & BOARD --------------------
model Project {
  id           Int             @id @default(autoincrement()) @map("id")
  key          String          @unique @map("key")
  name         String?         @map("name")
  createdBy   Int             @map("created_by")
  createdAt   DateTime        @default(now()) @map("created_at")

  creator      User            @relation("ProjectsCreated", fields: [createdBy], references: [id], onDelete: Restrict, onUpdate: Cascade)
  projectUsers ProjectUser[]
  boards       Board[]
  tickets      Ticket[]

  @@map("projects")
}

model ProjectUser {
  userId    Int @map("user_id")
  projectId Int @map("project_id")
  joinedAt  DateTime @default(now()) @map("joined_at")

  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([userId, projectId])

  @@index([projectId])

  @@map("project_users")
}

model Board {
  id           Int         @id @default(autoincrement()) @map("id")
  projectId   Int         @map("project_id")
  type         BoardType   @map("type")
  name         String      @map("name")
  createdAt   DateTime    @default(now()) @map("created_at")

  project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  columns      BoardColumn[]
  sprints      Sprint[]
  tickets      Ticket[]

  @@index([projectId])

  @@map("boards")
}

model BoardColumn {
  id        Int     @id @default(autoincrement()) @map("id")
  boardId  Int     @map("board_id")
  name      String  @map("name")
  position  Int     @map("position")

  board     Board   @relation(fields: [boardId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  tickets   Ticket[]

  @@unique([boardId, position])
  @@unique([boardId, name])
  @@map("board_columns")
}

// -------------------- SPRINT MANAGEMENT --------------------
model Sprint {
  id         Int          @id @default(autoincrement()) @map("id")
  boardId   Int          @map("board_id")
  name       String?      @map("name")
  status     SprintStatus @map("status")
  startDate DateTime?    @map("start_date")
  endDate   DateTime?    @map("end_date")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  board      Board        @relation(fields: [boardId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  tickets    Ticket[]

  @@index([boardId])

  @@map("sprints")
}

// -------------------- TICKETS --------------------
model TicketType {
  id      Int      @id @default(autoincrement()) @map("id")
  name    String   @unique @map("name")
  tickets Ticket[]

  @@map("ticket_types")
}

model Priority {
  id      Int      @id @default(autoincrement()) @map("id")
  name    String   @unique @map("name")
  tickets Ticket[]

  @@map("priorities")
}

model Ticket {
  id                 BigInt       @id @default(autoincrement()) @map("id")
  keyNumber         Int          @map("key_number")
  projectId         Int          @map("project_id")
  boardId           Int          @map("board_id")
  sprintId          Int?         @map("sprint_id")
  parentTicketId   BigInt?      @map("parent_ticket_id")
  typeId            Int          @map("type_id")
  startDate         DateTime?    @map("start_date")
  dueDate           DateTime?    @map("due_date")
  statusId          Int          @map("status_id")
  title              String       @map("title")
  description        String?      @map("description")
  priorityId        Int          @map("priority_id")
  reporterId        Int          @map("reporter_id")
  assigneeId        Int?         @map("assignee_id")
  storyPointEstimate Int?       @map("story_point_estimate")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  project       Project     @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  board         Board       @relation(fields: [boardId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  sprint        Sprint?     @relation(fields: [sprintId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  type          TicketType  @relation(fields: [typeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  priority      Priority    @relation(fields: [priorityId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  status        BoardColumn @relation(fields: [statusId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  reporter      User        @relation("ReportedTickets", fields: [reporterId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  assignee      User?       @relation("AssignedTickets", fields: [assigneeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  parent        Ticket?     @relation("SubTasks", fields: [parentTicketId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  subtasks      Ticket[]    @relation("SubTasks")

  labels        TicketLabel[]
  comments      TicketComment[]
  history       TicketHistory[]
  attachments   Attachment[]

  @@unique([projectId, keyNumber])

  @@index([boardId])
  @@index([sprintId])
  @@index([statusId])
  @@index([assigneeId])
  @@index([reporterId])
  @@index([parentTicketId])

  @@map("tickets")
}

model Label {
  id      Int      @id @default(autoincrement()) @map("id")
  name    String  @unique @map("name")
  tickets TicketLabel[]

  @@map("labels")
}

model TicketLabel {
  ticketId BigInt @map("ticket_id")
  labelId  Int @map("label_id")

  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  label    Label  @relation(fields: [labelId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([ticketId, labelId])
  @@map("ticket_labels")
}

// -------------------- COMMENTS --------------------
model TicketComment {
  id         BigInt   @id @default(autoincrement()) @map("id")
  ticketId  BigInt   @map("ticket_id")
  userId    Int      @map("user_id")
  message    String   @map("message")
  isEdited  Boolean  @default(false) @map("is_edited")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([ticketId])

  @@map("ticket_comments")
}

// -------------------- HISTORY --------------------
model TicketHistory {
  id         BigInt   @id @default(autoincrement()) @map("id")
  ticketId  BigInt   @map("ticket_id")
  action     TicketAction   @map("action")
  oldValue  Json?    @map("old_value")
  newValue  Json?    @map("new_value")
  updatedBy Int      @map("updated_by")
  createdAt DateTime @default(now()) @map("created_at")

  ticket     Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user       User   @relation("UpdatedHistories", fields: [updatedBy], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([ticketId])

  @@map("ticket_history")
}

// -------------------- ATTACHMENTS --------------------
model Attachment {
  id         BigInt   @id @default(autoincrement()) @map("id")
  ticketId  BigInt   @map("ticket_id")
  uploadedBy Int     @map("uploaded_by")
  fileUrl   String   @map("file_url")
  fileName  String   @map("file_name")
  fileSize  Int      @map("file_size")
  mimeType  String   @map("mime_type")
  createdAt DateTime @default(now()) @map("created_at")

  ticket     Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  uploadedByUser       User   @relation(fields: [uploadedBy], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([ticketId])

  @@map("attachments")
}
